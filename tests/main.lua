local elements = {
  [8695] = {
    air = false,
    ammo = {
      [1] = {
        count = 45,
        defName = "rifle",
      },
      [2] = {
        count = 1,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 5984,
    teamID = 3,
  },
  [23] = {
    air = false,
    ammo = {
      [1] = {
        count = 25,
        defName = "mg",
      }
    },
    defName = "machinegunner",
    distance = 350,
    teamID = 1,    
  },
  [2454] = {
    air = true,
    ammo = {
      [1] = {
        count = 1140,
        defName = "aircannon",
      }
    },
    defName = "fighter",
    distance = 1840,
    teamID = 2,    
  },
  [13541] = {
    air = false,
    ammo = {
      [1] = {
        count = 15,
        defName = "rifle",
      },
      [2] = {
        count = 3,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 5321,
    teamID = 3,
  },
  [13544] = {
    air = false,
    ammo = {
      [1] = {
        count = 25,
        defName = "rifle",
      },
      [2] = {
        count = 2,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 5328,
    teamID = 3,
  },
  [14584] = {
    air = false,
    ammo = {
      [1] = {
        count = 45,
        defName = "rifle",
      },
      [2] = {
        count = 1,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 5228,
    teamID = 3,
  },
  [19854] = {
    air = false,
    ammo = {
      [1] = {
        count = 70,
        defName = "rifle",
      },
      [2] = {
        count = 6,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 5541,
    teamID = 3,
  },
  [52411] = {
    air = false,
    ammo = {
      [1] = {
        count = 7,
        defName = "HE",
      },
      [2] = {
        count = 15,
        defName = "sabot",
      },
    },
    defName = "tank",
    distance = 684,
    teamID = 1,
  },
  [58411] = {
    air = false,
    ammo = {
      [1] = {
        count = 5,
        defName = "HE",
      },
      [2] = {
        count = 8,
        defName = "sabot",
      },
    },
    defName = "tank",
    distance = 1001,
    teamID = 1,
  },
  [98741] = {
    air = false,
    ammo = {
      [1] = {
        count = 17,
        defName = "HE",
      },
      [2] = {
        count = 0,
        defName = "sabot",
      },
    },
    defName = "tank",
    distance = 1021,
    teamID = 2,
  },
  [22248] = {
    air = false,
    ammo = {
      [1] = {
        count = 18,
        defName = "rifle",
      },
      [2] = {
        count = 4,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 284,
    teamID = 1,
  },
  [85471] = {
    air = false,
    ammo = {
      [1] = {
        count = 0,
        defName = "rifle",
      },
      [2] = {
        count = 2,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 284,
    teamID = 1,
  },
  [95450] = {
    air = false,
    ammo = {
      [1] = {
        count = 0,
        defName = "rifle",
      },
      [2] = {
        count = 0,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 400,
    teamID = 1,
  },
  [95520] = {
    air = false,
    ammo = {
      [1] = {
        count = 0,
        defName = "rifle",
      },
      [2] = {
        count = 5,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 421,
    teamID = 1,
  },
  [89562] = {
    air = false,
    ammo = {
      [1] = {
        count = 0,
        defName = "rifle",
      },
      [2] = {
        count = 5,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 500,
    teamID = 1,
  },
  [84515] = {
    air = false,
    ammo = {},
    defName = "bugBuilder",
    distance = 1080,
    teamID = 4,
  },
  [98741] = {
    air = false,
    ammo = {
      [1] = {
        count = math.huge,
        defName = "acid",
      }
    },
    defName = "bugSpitter",
    distance = 1080,
    teamID = 4,
  },
}

local inserts = {
  [14751] = {
    air = false,
    ammo = {
      [1] = {
        count = 15,
        defName = "HE",
      },
      [2] = {
        count = 14,
        defName = "sabot",
      },
    },
    defName = "tank",
    distance = 2685,
    teamID = 1,
  },
  [95520] = {
    air = false,
    ammo = {
      [1] = {
        count = 14,
        defName = "HE",
      },
      [2] = {
        count = 14,
        defName = "sabot",
      },
    },
    defName = "tank",
    distance = 552,
    teamID = 1,
  },
  [84564] = {
    air = false,
    ammo = {},
    defName = "bugBuilder",
    distance = 1154,
    teamID = 4,
  },
  [84585] = {
    air = false,
    ammo = {},
    defName = "bugBuilder",
    distance = 1150,
    teamID = 4,
  },
  [55854] = {
    air = false,
    ammo = {
      [1] = {
        count = 58,
        defName = "rifle",
      },
      [2] = {
        count = 3,
        defName = "grenade",
      },
    },
    defName = "soldier",
    distance = 400,
    teamID = 2,
  },
  [11474] = {
    air = true,
    ammo = {
      [1] = {
        count = 1300,
        defName = "aircannon",
      }
    },
    defName = "fighter",
    distance = 10585,
    teamID = 2,    
  },
}

local deletionsByID = {8695, 84585, 84515}
local N = 10
local ARRAY = {10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 90, 80, 70, 60, 50, 40, 30, 20, 10}
local SMALL_ARRAY = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
local NTH = 5
local TABLE = {
  ALPHA = "a",
  BETA = "b",
  GAMMA = "c",
  DELTA = "d",
}
local EMPTY_ARRAY = {}
local EMPTY_TABLE = {
}

--Given number N, print all numbers up to N.
function print_all_to_N(n)
  for i = 1, n do
    print(i)
  end
end
--Given number N, print every odd number up to N without using an if.
function print_all_odd_to_N(n)
  for i = 1, n, 2 do
    print(i)
  end
end
--Given number N, print all numbers up to N in reverse order.
function print_all_to_N_reverse(n)
  for i = n, 1, -1 do
    print(i)
  end
end
--Given an array of numbers, print the sum of all of them.
function print_array_sum(array)
  local s = 0
  for _, v in ipairs(array) do
    s = s + v
  end
  print(s)
end
--Given an array of numbers, print the index of the largest number.
function print_array_largest_index(array)
  local max, mi = array[1], 1
  for i, v in ipairs(array) do
    if max < v then
      mi = i
      max = v
    end
  end
  print(mi, " with value ", max)
end
--Given number N, make an array containing the squares of every number up to N.
function new_array_squared_of_given_size(n)
  local new_array = {}
  for i = 1, n do
    new_array[i] = i * i
  end
  return new_array
end
-- Given an array of numbers and a number N, print the N-th odd number in the array.
function get_array_nth_odd_value(array, nth)
  for i,v in ipairs(array) do
    if v % 2 == 1 then
      nth = nth - 1
    end
    if nth == 0 then
      return v
    end
  end
end
--Given an array, print every element and its index.
function print_array(array)
  for i, v in ipairs(array) do 
      print(i, v) 
  end
end
--Given an array, print every element and its index. In single line...
function print_array_inline(array)
  local str = ""
  for i, v in ipairs(array) do 
      str = str .. "[" .. i .. "," .. v .. "]" 
  end
  print(str)
end
--Given a table, print every element and its key.
function print_table(table)
  for k, v in pairs(table) do 
      print(k, v) 
  end
end
--Given a table, print every element and its key. In single line...
function print_table_inline(array)
  local str = ""
  for k, v in pairs(array) do 
      str = str .. "[" .. k .. "," .. v .. "]" 
  end
  print(str)
end
--Given an array, count the number of its elements.
function get_array_element_count(array)
  local count = 0
  for _, _ in ipairs(array) do
    count = count + 1
  end
  return count
end
--Given a table, count the number of its elements.
function get_table_element_count(table)
  local count = 0
  for _, _ in pairs(table) do
    count = count + 1
  end
  return count
end
--Given an array, determine if it is empty.
function is_array_empty(array)
  if array == nil or type(array) ~= "table" then
    return false
  end
  return next(array) == nil
end
--Given a table, determine if it is empty.
function is_table_empty(table)
  if table == nil or type(table) ~= "table" then
    return false
  end
  return next(table) == nil
end
--Create a function that can print any boolean, number, string, array or table; arrays and. tables may themselves contain arrays and tables.
function print_prefix(prefix, value)
  if prefix ~= nil then
    print(prefix .. value)
  else
    print(value)
  end
end
function print_anything(value, indent, prefix)
  indent = indent or ""
  if type(value) == "table" then
      print_prefix(prefix, "{")
      for k, v in pairs(value) do
        if type(k) == "number" then
          print_anything(v, indent .. "  ", indent .. "  " .. "[" ..tostring(k) .. "]" .. " = ")
        else
          print_anything(v, indent .. "  ", indent .. "  " .. tostring(k) .. " = ")
        end
      end
      print(indent .. "},")
  else
    if type(value) == "string" then
      print_prefix(prefix, '"' ..tostring(value) .. '"' .. ",")
    else
      print_prefix(prefix, tostring(value) .. ",")
    end
  end
end

--a function that takes an array and a predicate, and returns an array of all elements that pass the predicate.
function filter_array(array, predicate)
  local new_array = {}
  for _, v in ipairs(array) do
    if predicate(v) then
      table.insert(new_array, v)
    end
  end
  return new_array
end

-- BASICS
-- Basics loops 3/3
--print_all_to_N(N)
--print_all_odd_to_N(N)
--print_all_to_N_reverse(N)
-- Basics arrays 4/4
--print_array_sum(ARRAY)
--print_array_largest_index(ARRAY)
--print_array(new_array_squared_of_given_size(N))
--print(get_array_nth_odd_value(SMALL_ARRAY, NTH))
-- Basics tables 6/6
--print_array_inline(SMALL_ARRAY)
--print_table_inline(TABLE)
--print(get_array_element_count(SMALL_ARRAY))
--print(get_table_element_count(TABLE))
--print(is_array_empty(SMALL_ARRAY))
--print(is_table_empty(TABLE))
--print(is_array_empty(nil))
--print(is_table_empty(nil))
--print(is_array_empty(1))
--print(is_table_empty(1))
--print(is_array_empty(EMPTY_ARRAY))
--print(is_table_empty(EMPTY_TABLE))
-- Basic applications
--print_anything(elements)
--print_anything(filter_array(SMALL_ARRAY, function(v) return v >= 5 end))

--Advanced tasks
--Use Inputs to Initalize table by reading elements
  --Insert all new elements contained in inserts
  --Delete all elements by ID contained in deletionsByID
function init_table_by_inputs(table, inserts, deletionsByID)
  -- Insert all new elements
  print(get_table_element_count(table))
  for id, unit in pairs(inserts) do
    table[id] = unit
  end
  print(get_table_element_count(table))
  -- Delete elements by ID
  for _, id in ipairs(deletionsByID) do
    table[id] = nil
  end
  print(get_table_element_count(table))
  return table
end

local final_table = init_table_by_inputs(elements, inserts, deletionsByID)
--QUERIES
function filter_access_table(table, predicate)
  for idx, item in pairs(table) do
    if predicate(item) then
      coroutine.yield(item)
    end
  end
  return nil
end

function coroutine_test(table, executer, predicate)
  local co = coroutine.create(function()
    filter_access_table(table, predicate)
  end)
  -- Resuming the coroutine and printing results until completion
  while coroutine.status(co) ~= "dead" do
    local success, result = coroutine.resume(co)
    if success and result ~= nil then
      executer(result)  -- execute over filtered values
    end
  end
end
--Query all “air” units
--Query all “tank” units
--Query ammunition of “tank” units of team 1
--Query all units in team 4 which has some weapon (no ammo means unit has not weapon).
--Query all enemy units in 1500 radius considering
  --You are team 1
  --All other teams are enemies
local RANGE_CONST = 1500
--coroutine_test(final_table, print_anything, function(unit) return unit.air == true end)
--coroutine_test(final_table, print_anything, function(unit) return unit.defName == "tank" end)
--coroutine_test(final_table, print_anything, function(unit) return unit.defName == "tank" and unit.teamID == 1 and unit.ammo and next(unit.ammo) ~= nil end)
--coroutine_test(final_table, print_anything, function(unit) return unit.teamID == 4 and unit.ammo and next(unit.ammo) ~= nil end)
--coroutine_test(final_table, print_anything, function(unit) return unit.teamID ~= 1 and unit.distance <= RANGE_CONST end)


--Measure for each one of 4 teams:
  --How many grenades they have available per unit
  --How many grenades they have available per “soldier” unit

local TEAMS_STATS = {
  TOTAL = {0, 0, 0, 0},
  SOLDIERS = {0, 0, 0, 0},
  GRENADES = {0, 0, 0, 0},
  WEAPON = {0, 0, 0, 0}, -- count as 1
  BIG_WEAPON = {0, 0, 0, 0}, -- count as 10
}

function process_team_unit(unit, team)
  TEAMS_STATS.TOTAL[team] = TEAMS_STATS.TOTAL[team] + 1
  if unit.defName == "soldier" then
    TEAMS_STATS.SOLDIERS[team] = TEAMS_STATS.SOLDIERS[team] + 1
  end
  if unit.ammo then
    for _, ammo in pairs(unit.ammo) do
      if ammo.defName == "grenade" then
        TEAMS_STATS.GRENADES[team] = TEAMS_STATS.GRENADES[team] + ammo.count
      end
      if ammo.defName == "rifle" or ammo.defName == "machinegun" or ammo.defName == "acid" then
        TEAMS_STATS.WEAPON[team] = TEAMS_STATS.WEAPON[team] + ammo.count
      end
      if ammo.defName == "HE" then
        TEAMS_STATS.BIG_WEAPON[team] = TEAMS_STATS.BIG_WEAPON[team] + ammo.count
      end
    end
  end
end
-- this is straight up evil use of coroutine, but whatever it's going to work for this assignment
coroutine_test(final_table, function(unit)  process_team_unit(unit, 1) end, function(unit) return unit.teamID == 1 end)
coroutine_test(final_table, function(unit)  process_team_unit(unit, 2) end, function(unit) return unit.teamID == 2 end)
coroutine_test(final_table, function(unit)  process_team_unit(unit, 3) end, function(unit) return unit.teamID == 3 end)
coroutine_test(final_table, function(unit)  process_team_unit(unit, 4) end, function(unit) return unit.teamID == 4 end)
print_anything(TEAMS_STATS)
function print_final_ratios(ST)
  -- Calculate averages
  for team = 1, 4 do
    -- Ensure no division by zero
    local gpu = ST.GRENADES[team] ~= 0 and ST.TOTAL[team] / ST.GRENADES[team] or 0
    local gps = ST.GRENADES[team] ~= 0 and ST.SOLDIERS[team] / ST.GRENADES[team] or 0

    -- Format the string with calculated GPU and GPS values
    local str = string.format("Team %d: GPU %.2f, GPS %.2f", team, gpu, gps)
    print(str)
  end
end
print_final_ratios(TEAMS_STATS)

--Considering “rifle”, “machinegun”, “acid” is ammunition which can kill 1 “soldier” and “HE” is ammunition which can kill 10 “soldiers”, for each one of 4 teams make decision:
  --With all units our team have available can we kill 100 soldiers? YES/NO
function print_final_test(ST)
  -- Calculate averages
  for team = 1, 4 do
    -- Ensure no division by zero
    local weapon = ST.WEAPON[team] * 1 + ST.WEAPON[team] * 10
    local grenades = ST.GRENADES[team]

    -- Format the string with calculated GPU and GPS values
    local str = string.format("Team %d: WEAPON %.2f, GRENADES %.2f, CAN KILL? %s", team, weapon, grenades, tostring(weapon >= 100))
    print(str)
  end
end
print_final_test(TEAMS_STATS)
